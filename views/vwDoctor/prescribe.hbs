<div class="container py-5">

    {{!-- 1. HEADER --}}
    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h2 class="fw-bold text-primary mb-1">
                <i class="fas fa-prescription me-2"></i>Kê đơn thuốc
            </h2>
            <p class="text-muted mb-0">Chọn thuốc và chỉ định liều dùng cho bệnh nhân.</p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <a href="/doctor/home" class="btn btn-outline-secondary rounded-pill hover-shadow">
                <i class="fas fa-arrow-left me-2"></i>Quay về
            </a>
        </div>
    </div>

    {{!-- 2. FORM KÊ TOA --}}
    <form method="POST" id="prescriptionForm">
        {{!-- Input ẩn chứa JSON danh sách thuốc để gửi về server --}}
        <input type="hidden" id="itemsInput" name="items">

        <div class="row g-4">
            
            {{!-- CỘT TRÁI: FORM NHẬP --}}
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-plus-circle me-2"></i>Thêm thuốc mới</h6>
                    </div>
                    <div class="card-body p-4">
                        
                        {{!-- Chọn thuốc --}}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tên thuốc</label>
                            <select id="medSelect" class="form-select">
                                <option value="" disabled selected>-- Chọn loại thuốc --</option>
                                {{#each meds}}
                                    {{!-- Lưu thêm data-name và data-unit để JS dễ lấy hiển thị --}}
                                    <option value="{{this.medicine_id}}" 
                                            data-name="{{this.medicine_name}}" 
                                            data-unit="{{this.unit}}"
                                            data-stock="{{this.stock_quantity}}">
                                        {{this.medicine_name}} (Còn: {{this.stock_quantity}} {{this.unit}})
                                    </option>
                                {{/each}}
                            </select>
                        </div>

                        {{!-- Số lượng & Đơn vị --}}
                        <div class="row g-2 mb-3">
                            <div class="col-8">
                                <label class="form-label fw-bold">Số lượng</label>
                                <input type="number" id="qtyInput" class="form-control" placeholder="0" min="1">
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold">Đơn vị</label>
                                <input type="text" id="unitDisplay" class="form-control bg-light" disabled placeholder="-">
                            </div>
                        </div>

                        {{!-- Liều dùng --}}
                        <div class="mb-4">
                            <label class="form-label fw-bold">Liều dùng / Ghi chú</label>
                            <textarea id="dosageInput" class="form-control" rows="3" placeholder="VD: Sáng 1 viên, Tối 1 viên (Sau ăn)"></textarea>
                        </div>

                        {{!-- Nút Thêm --}}
                        <button type="button" onclick="addItem()" class="btn btn-primary w-100 rounded-pill fw-bold">
                            <i class="fas fa-arrow-right me-2"></i>Thêm vào toa
                        </button>
                    </div>
                </div>
            </div>

            {{!-- CỘT PHẢI: DANH SÁCH ĐÃ KÊ --}}
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4">
                        <h5 class="fw-bold text-dark border-start border-4 border-success ps-3">
                            <i class="fas fa-list-ol me-2 text-success"></i>Chi tiết toa thuốc
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="bg-light text-secondary">
                                    <tr>
                                        <th scope="col" class="ps-3">Tên thuốc</th>
                                        <th scope="col" class="text-center">SL</th>
                                        <th scope="col" class="text-center">Đơn vị</th>
                                        <th scope="col">Liều dùng</th>
                                        <th scope="col" class="text-end pe-3">Xóa</th>
                                    </tr>
                                </thead>
                                <tbody id="prescriptionTableBody">
                                    {{!-- Dòng trống mặc định --}}
                                    <tr id="emptyRow">
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            <i class="fas fa-file-medical fa-2x mb-3 opacity-25"></i>
                                            <p class="mb-0">Chưa có thuốc nào trong toa.</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-top-0 pb-4 text-end">
                        <button type="submit" class="btn btn-success btn-lg rounded-pill px-5 shadow-sm">
                            <i class="fas fa-save me-2"></i>Hoàn tất toa thuốc
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{{!-- JAVASCRIPT XỬ LÝ GIAO DIỆN --}}
<script>
    // Mảng chứa danh sách thuốc tạm thời
    let prescriptionList = [];

    const medSelect = document.getElementById('medSelect');
    const unitDisplay = document.getElementById('unitDisplay');
    const qtyInput = document.getElementById('qtyInput');
    const dosageInput = document.getElementById('dosageInput');
    const tableBody = document.getElementById('prescriptionTableBody');
    const itemsInput = document.getElementById('itemsInput');
    const emptyRow = document.getElementById('emptyRow');

    // 1. Tự động hiện Đơn vị khi chọn thuốc
    medSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const unit = option.getAttribute('data-unit');
        unitDisplay.value = unit || '-';
    });

    // 2. Hàm Thêm thuốc
    function addItem() {
        const medId = medSelect.value;
        const qty = qtyInput.value;
        const dosage = dosageInput.value.trim();

        // Validate cơ bản
        if (!medId) {
            alert("Vui lòng chọn thuốc!");
            return;
        }
        if (!qty || qty <= 0) {
            alert("Vui lòng nhập số lượng hợp lệ!");
            return;
        }

        // Lấy thông tin chi tiết từ thẻ Option để hiển thị
        const selectedOption = medSelect.options[medSelect.selectedIndex];
        const medName = selectedOption.getAttribute('data-name');
        const unit = selectedOption.getAttribute('data-unit');
        const stock = parseInt(selectedOption.getAttribute('data-stock'));

        // Check tồn kho (Optional)
        if (parseInt(qty) > stock) {
            alert(`Kho chỉ còn ${stock} ${unit}. Không đủ hàng!`);
            return;
        }

        // Thêm vào mảng dữ liệu
        prescriptionList.push({
            medicine_id: medId,
            medicine_name: medName, // Chỉ để hiện, không cần gửi về server nếu backend không cần
            quantity: qty,
            unit: unit,             // Chỉ để hiện
            dosage: dosage
        });

        // Cập nhật giao diện & Input hidden
        renderTable();
        resetForm();
    }

    // 3. Hàm Vẽ lại bảng
    function renderTable() {
        // Cập nhật input hidden để gửi form
        itemsInput.value = JSON.stringify(prescriptionList.map(item => ({
            medicine_id: item.medicine_id,
            qty: item.quantity,
            dosage: item.dosage
        })));

        // Xóa nội dung bảng cũ (trừ dòng empty nếu mảng rỗng)
        tableBody.innerHTML = '';

        if (prescriptionList.length === 0) {
            tableBody.appendChild(emptyRow);
            return;
        }

        // Duyệt mảng và vẽ dòng mới
        prescriptionList.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="ps-3 fw-bold text-dark">${item.medicine_name}</td>
                <td class="text-center">
                    <span class="badge bg-light text-dark border">${item.quantity}</span>
                </td>
                <td class="text-center text-muted small">${item.unit}</td>
                <td><small>${item.dosage || 'Theo chỉ định'}</small></td>
                <td class="text-end pe-3">
                    <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="removeItem(${index})" title="Xóa">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // 4. Hàm Xóa dòng
    function removeItem(index) {
        prescriptionList.splice(index, 1); // Xóa phần tử tại index
        renderTable(); // Vẽ lại bảng
    }

    // 5. Reset form nhập liệu
    function resetForm() {
        medSelect.value = "";
        unitDisplay.value = "";
        qtyInput.value = "";
        dosageInput.value = "";
        medSelect.focus();
    }
</script>

<style>
    .hover-shadow:hover {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
</style>